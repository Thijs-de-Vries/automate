# Automate Project Backlog
# Issues are removed once completed (tracked in git commits)

# Template for new issues:
# - id: unique-kebab-case-id
#   title: Brief descriptive title
#   description: Detailed description of the issue
#   priority: Critical | High | Medium | Low
#   status: open | in-progress | blocked
#   affected_files:
#     - path/to/file.ts
#     - path/to/another/file.tsx
#   notes: Optional additional context

issues:
  - id: connection-indicator-missing
    title: No Convex connection status indicator
    description: |
      When app is restarted or wakes from idle, Convex needs to reconnect but there's no visual indicator.
      Users see blank screens or stale data without knowing if connection is active/reconnecting.
      Need persistent banner similar to OfflineBanner.tsx for connection states.
    priority: Critical
    status: open
    affected_files:
      - src/main.tsx
      - src/App.tsx
      - src/contexts/SpaceContext.tsx
    notes: |
      Should distinguish between:
      - Network offline (existing OfflineBanner)
      - Convex connecting/reconnecting
      - Convex connection failed
      Mobile-first design required.

  - id: apartment-workflow-clunky
    title: Apartment app workflow needs simplification
    description: |
      Current approval flow (pending → approve → order → deliver) is too clunky and involves too many steps.
      Notifications are broken. Actual price field exists in schema but no UI to set it.
      Too many modals for every action - not mobile-friendly.
    priority: High
    status: open
    affected_files:
      - src/apps/apartment/ApartmentApp.tsx
      - convex/apartment.ts
      - convex/schema.ts
    notes: |
      User feedback:
      - Steps are too clunky
      - Want simpler flow for adding/buying items
      - Notifications not working
      - Missing actual price input in UI
      Consider inline actions instead of modals.

  - id: notifications-system-broken
    title: Push notifications not working
    description: |
      Notification system exists but not functioning properly.
      Users not receiving push notifications for apartment items, comments, etc.
      Service worker handles push events but registration/subscription may be broken.
    priority: High
    status: open
    affected_files:
      - src/sw.ts
      - src/hooks/usePushNotifications.ts
      - convex/notifications.ts
      - convex/notificationsNode.ts
    notes: |
      Check:
      - Push subscription registration
      - Notification permissions
      - Convex notification sending logic
      - Service worker push event handling

  - id: update-mechanism-fragmented
    title: Update mechanism doesn't integrate SW and version checking
    description: |
      Version checking via Convex (useVersionCheck) and service worker updates (useServiceWorker) are disconnected.
      SW updates cache but app doesn't force reload. Version checks work but ignore SW state.
      Can cause mismatched assets (new JS with old cached files or vice versa).
      Users report "weird refresh behavior" on updates.
    priority: High
    status: open
    affected_files:
      - src/contexts/UpdateContext.tsx
      - src/hooks/useVersionCheck.ts
      - src/hooks/useServiceWorker.ts
      - src/components/UpdateToast.tsx
      - vite.config.ts
    notes: |
      Should unify:
      - Detect both SW update AND version mismatch
      - Force reload when both change
      - Better user communication about updates
      - Remove 15-min cooldown for critical updates

  - id: logo-navigation-home
    title: Logo should navigate to home page
    description: |
      Users want clicking the logo to return to home page instead of repeatedly pressing back button.
      Current navigation only has back arrow on individual app pages.
    priority: Medium
    status: open
    affected_files:
      - src/App.tsx
      - src/apps/*/components or layout
    notes: |
      Should work from any nested route.
      Consider if logo should always show or only on app pages.

  - id: query-error-handling-missing
    title: No error handling for failed queries
    description: |
      All useQuery calls use `?? []` or `?? undefined` fallback pattern which masks errors.
      Users can't tell if data failed to load vs. actually empty.
      No retry UI for failed queries.
    priority: Medium
    status: open
    affected_files:
      - src/apps/tasks/TasksApp.tsx
      - src/apps/apartment/ApartmentApp.tsx
      - src/apps/packing/PackingApp.tsx
      - src/apps/public-transport/PublicTransportApp.tsx
      - src/apps/calisthenics/CalisthenicsApp.tsx
    notes: |
      Need consistent pattern for:
      - Loading state
      - Error state with retry button
      - Empty state
      Reference PublicTransportApp.tsx for good error handling example.

  - id: mutation-error-feedback-poor
    title: Mutation errors shown as alerts or silent failures
    description: |
      Most mutations wrapped in try/catch with only console.log or alert() for errors.
      Need toast notification system for better UX.
      Loading states inconsistent across apps.
    priority: Medium
    status: open
    affected_files:
      - src/apps/tasks/TasksApp.tsx
      - src/apps/apartment/ApartmentApp.tsx
      - src/apps/packing/PackingApp.tsx
      - src/apps/calisthenics/CalisthenicsApp.tsx
    notes: |
      Consider:
      - Shadcn toast/sonner component
      - Standardized useMutation wrapper with error handling
      - Loading button states

  - id: no-error-boundaries
    title: No React error boundaries implemented
    description: |
      Single render error anywhere crashes entire app.
      Need top-level error boundary and per-route boundaries for graceful degradation.
    priority: Low
    status: open
    affected_files:
      - src/App.tsx
      - src/main.tsx
    notes: |
      Should show user-friendly error page with:
      - Error message
      - Reload button
      - Report issue option (if applicable)

  - id: no-tests-infrastructure
    title: No testing infrastructure exists
    description: |
      Zero test files in entire codebase. No unit tests, integration tests, or E2E tests.
      No testing framework configured (Jest, Vitest, Playwright, etc).
      Critical business logic (approval workflow, notifications, cron scheduling) is untested.
    priority: Medium
    status: open
    affected_files:
      - package.json
    notes: |
      Consider adding:
      - Vitest for unit tests
      - React Testing Library for component tests
      - Playwright for E2E tests on critical flows
      Priority after basic infrastructure is stable.

  - id: env-vars-not-validated
    title: Environment variables not validated at startup
    description: |
      App uses multiple env vars (VITE_CONVEX_URL, VITE_CLERK_PUBLISHABLE_KEY, VAPID keys, NS_API_KEY)
      but doesn't validate they exist at startup. Missing env vars cause cryptic runtime errors.
      Users report blank screens which could be missing CONVEX_URL.
    priority: High
    status: open
    affected_files:
      - src/main.tsx
      - convex/notificationsNode.ts
      - convex/publicTransportActions.ts
    notes: |
      Add validation at app startup:
      - Check required env vars exist
      - Show user-friendly error if missing
      - Prevent app initialization with bad config

  - id: apartment-1372-lines
    title: ApartmentApp.tsx is 1372 lines - needs refactoring
    description: |
      Single file contains entire apartment app with 9+ components defined inline.
      Makes code hard to maintain, test, and understand.
      Should be split into separate files.
    priority: Medium
    status: open
    affected_files:
      - src/apps/apartment/ApartmentApp.tsx
    notes: |
      Extract to separate files:
      - ItemCard.tsx
      - ItemDetailModal.tsx
      - AddItemModal.tsx
      - FilterMenu.tsx
      - CommentSection.tsx
      - ApprovalButtons.tsx
      Also extract custom hooks:
      - useItemFiltering
      - useItemStats
      - useCommentReactions

  - id: alert-calls-for-errors
    title: Using alert() for error messages instead of toast notifications
    description: |
      Multiple files use alert() for errors which blocks UI and looks unprofessional.
      PublicTransportApp uses alert() for sync success/errors.
      Need proper toast notification system.
    priority: Medium
    status: open
    affected_files:
      - src/apps/public-transport/PublicTransportApp.tsx
      - src/apps/public-transport/PublicTransportApp.old.tsx
    notes: |
      Options:
      - Add shadcn/ui sonner toast component
      - Use react-hot-toast
      - Build custom toast system
      Should be non-blocking, auto-dismiss, stackable.

  - id: no-professional-logging-infrastructure
    title: Need professional logging infrastructure for automation and debugging
    description: |
      Currently using scattered console.log/error calls (20+ instances).
      For automation and production use, need structured logging system with:
      - Log levels (debug, info, warn, error, fatal)
      - Context awareness (module, user, spaceId, action)
      - Configurable per module and environment
      - Optional external service integration (e.g., Sentry, LogRocket, BetterStack)
      - Correlation IDs for tracing requests
      - Performance metrics logging
      - Cron job execution logging
      - Structured JSON format for parsing
    priority: High
    status: open
    affected_files:
      - src/lib/logger.ts (to create)
      - src/hooks/useServiceWorker.ts
      - src/apps/public-transport/PublicTransportApp.tsx
      - src/apps/apartment/ApartmentApp.tsx
      - src/apps/groups/GroupSettingsPage.tsx
      - convex/crons.ts
      - convex/apartment.ts
      - convex/tasks.ts
      - convex/publicTransportActions.ts
    notes: |
      Implementation approach:
      1. Create src/lib/logger.ts with Logger class
      2. Create convex/lib/logger.ts for backend logging
      3. Support different transports:
         - Console (dev)
         - Remote service (production)
         - Local storage (offline debugging)
      4. Include context automatically:
         - userId from Clerk
         - spaceId from context
         - Component/module name
         - Timestamp
         - User agent / device info
      5. Config via env vars:
         - LOG_LEVEL (debug/info/warn/error)
         - LOG_REMOTE_URL
         - LOG_MODULES (comma-separated whitelist)
      6. Replace all console.log/error calls
      7. Add logging to critical paths:
         - Cron executions
         - Notification sends
         - Mutation failures
         - API calls (NS, Clerk, Convex)
         - Connection state changes
         - Update mechanism triggers
      
      Example usage:
      ```typescript
      // Frontend
      import { logger } from '@/lib/logger'
      
      const log = logger.child({ module: 'ApartmentApp' })
      
      log.info('Item submitted', { itemId, category, urgency })
      log.error('Failed to submit item', { error, userId })
      
      // Backend (Convex)
      import { logger } from './lib/logger'
      
      const log = logger.child({ module: 'apartment', action: 'submit' })
      
      log.info('Processing submission', { userId, spaceId })
      log.error('Validation failed', { error, input: args })
      ```
      
      Consider libraries:
      - pino (fast, structured, Node.js)
      - winston (popular, flexible)
      - consola (beautiful console output)
      - Or build custom lightweight logger
      
      Future enhancements:
      - Log aggregation dashboard
      - Real-time log streaming
      - Alert on error patterns
      - Performance analytics
      - User behavior analytics

  - id: apartment-actual-price-no-ui
    title: Apartment actual price field exists but no UI to set it
    description: |
      Schema has actualPrice field but status change dropdowns don't ask for it.
      When marking item as "ordered" or "delivered", should prompt for actual price
      to compare against estimated price.
    priority: High
    status: open
    affected_files:
      - src/apps/apartment/ApartmentApp.tsx
      - convex/apartment.ts
    notes: |
      Add actual price input when changing status to ordered/delivered.
      Show comparison: "Estimated €50, Actual €45 (€5 saved)"
      Calculate total budget tracking across all items.

  - id: apartment-stored-dates-not-displayed
    title: Apartment orderedDate and deliveredDate stored but never shown
    description: |
      Schema stores orderedDate and deliveredDate but UI never displays them.
      Users can't see when items were ordered or delivered.
    priority: Low
    status: open
    affected_files:
      - src/apps/apartment/ApartmentApp.tsx
      - convex/apartment.ts
    notes: |
      Show dates in item detail modal or card:
      - "Ordered 3 days ago"
      - "Delivered yesterday"
      Use relative time formatting.

  - id: apartment-comment-no-edit-delete
    title: Cannot edit or delete comments in apartment app
    description: |
      Once posted, comments are permanent. Users cannot fix typos or remove inappropriate comments.
      Should allow comment author to edit/delete their own comments.
    priority: Medium
    status: open
    affected_files:
      - src/apps/apartment/ApartmentApp.tsx
      - convex/apartment.ts
    notes: |
      Add edit/delete actions:
      - Show edit/delete buttons for comment author
      - Edit in-place with save/cancel
      - Delete with confirmation
      - Track editedAt timestamp

  - id: apartment-no-search
    title: No search functionality for apartment items
    description: |
      With many items, finding specific one is difficult.
      Need search by name, description, or category.
    priority: Medium
    status: open
    affected_files:
      - src/apps/apartment/ApartmentApp.tsx
    notes: |
      Add search input at top:
      - Filter items by name/description
      - Highlight matching text
      - Show "X results" count
      - Clear button to reset search

  - id: apartment-filter-menu-ux
    title: Apartment filter menu slides from right - odd UX on desktop
    description: |
      Filter menu is full-screen overlay on mobile (good) but slides from right on desktop (odd).
      Should be dropdown or inline filters for better desktop UX.
    priority: Low
    status: open
    affected_files:
      - src/apps/apartment/ApartmentApp.tsx
    notes: |
      Mobile-first means mobile should be perfect.
      Desktop can use same design or optimize separately.
      Consider inline filter chips + dropdown for advanced filters.

  - id: apartment-no-image-preview
    title: No image preview when adding apartment item image URL
    description: |
      Users paste image URL but can't see if it works until after submitting.
      Should show image preview in add/edit modal.
    priority: Low
    status: open
    affected_files:
      - src/apps/apartment/ApartmentApp.tsx
    notes: |
      Add image preview:
      - Show thumbnail when URL entered
      - Detect broken images
      - Allow URL correction before submit

  - id: apartment-small-image-thumbnails
    title: Apartment item images are tiny (16-24px) in cards
    description: |
      Item images in list view are very small, hard to see what item looks like.
      Should be larger thumbnails (64-80px) for better visual recognition.
    priority: Medium
    status: open
    affected_files:
      - src/apps/apartment/ApartmentApp.tsx
    notes: |
      Increase image size in cards.
      Consider image gallery view option.
      Ensure mobile-friendly (not too large on small screens).

  - id: apartment-notification-tag-deduplication
    title: Apartment comment notifications use timestamp in tag causing duplicates
    description: |
      Notification tag includes timestamp which prevents deduplication.
      Each comment creates new notification instead of replacing previous one.
    priority: Medium
    status: open
    affected_files:
      - convex/apartment.ts
    notes: |
      Use itemId only for tag:
      tag: `apartment-item-${itemId}`
      This replaces all notifications for same item.

  - id: apartment-no-url-validation
    title: No URL validation for imageUrl and purchaseUrl fields
    description: |
      Users can enter invalid URLs which break UI or fail to load.
      Need client and server-side validation.
    priority: Low
    status: open
    affected_files:
      - src/apps/apartment/ApartmentApp.tsx
      - convex/apartment.ts
    notes: |
      Validate URLs:
      - Must start with http:// or https://
      - Show error message on invalid URL
      - Optional: Check if URL is reachable

  - id: apartment-negative-price-validation
    title: Can submit negative prices for apartment items
    description: |
      No validation prevents entering negative or zero prices.
      Should enforce positive numbers only.
    priority: Low
    status: open
    affected_files:
      - src/apps/apartment/ApartmentApp.tsx
      - convex/apartment.ts
    notes: |
      Add validation:
      - Price must be > 0
      - Reasonable maximum (e.g., €100,000)
      - Show helpful error message

  - id: apartment-delete-permissions
    title: Only admins can delete items, submitters cannot delete own items
    description: |
      Current logic only allows admin/creator to delete any item.
      Submitters should be able to delete their own pending items.
    priority: Low
    status: open
    affected_files:
      - convex/apartment.ts (line 466-475)
    notes: |
      Allow deletion if:
      - User is admin/creator (any item)
      - OR user is submitter AND status is pending

  - id: space-context-race-condition
    title: SpaceContext has potential race condition on initial load
    description: |
      Multiple useEffects in SpaceContext can trigger simultaneously causing
      unnecessary mutations and localStorage writes. Should consolidate logic.
    priority: Low
    status: open
    affected_files:
      - src/contexts/SpaceContext.tsx
    notes: |
      Review and simplify SpaceContext initialization logic.
      Use single useEffect with proper dependency array.
      Avoid redundant ensurePersonalSpace calls.

  - id: public-transport-old-file-exists
    title: PublicTransportApp.old.tsx file still in codebase
    description: |
      Old version of PublicTransportApp exists in codebase (1300+ lines).
      Should be removed to avoid confusion and reduce bundle size.
    priority: Low
    status: open
    affected_files:
      - src/apps/public-transport/PublicTransportApp.old.tsx
    notes: |
      Either:
      - Delete file if truly obsolete
      - Move to archive folder
      - Document why it's kept if needed for reference

  - id: cron-todo-oneoff-trips
    title: One-off trip scheduling not implemented
    description: |
      convex/crons.ts has TODO comment for one-off date scheduling.
      Feature is planned but not implemented. Should complete or remove TODO.
    priority: Low
    status: open
    affected_files:
      - convex/crons.ts (line 159)
      - convex/schema.ts (line 156)
    notes: |
      Either implement one-off trips or remove TODOs.
      If implementing:
      - Add oneOffDate field to schema
      - Add cron to check one-off trips
      - UI to toggle between recurring/one-off

  - id: service-worker-hook-unused
    title: useServiceWorker hook exists but never used
    description: |
      src/hooks/useServiceWorker.ts is implemented but not imported anywhere.
      Part of the update-mechanism-fragmented issue. Should be integrated.
    priority: High
    status: open
    affected_files:
      - src/hooks/useServiceWorker.ts
      - src/contexts/UpdateContext.tsx
    notes: |
      Related to update-mechanism-fragmented issue.
      Integrate with UpdateContext to unify SW and version checking.

  - id: no-pagination-anywhere
    title: No pagination implemented in any list view
    description: |
      All queries use .collect() which loads entire dataset.
      With hundreds of items, this will cause performance issues.
      Need pagination for tasks, apartment items, packing items, etc.
    priority: Low
    status: open
    affected_files:
      - convex/tasks.ts
      - convex/apartment.ts
      - convex/packing.ts
      - src/apps/tasks/TasksApp.tsx
      - src/apps/apartment/ApartmentApp.tsx
      - src/apps/packing/PackingApp.tsx
    notes: |
      Implement pagination:
      - Use Convex paginate() helper
      - Load more button or infinite scroll
      - Start with apartment app (most likely to have many items)

  - id: no-input-sanitization
    title: No input sanitization - XSS risk
    description: |
      User inputs (comments, descriptions, names) are not sanitized.
      If user enters HTML/script tags, could cause XSS attacks.
      React escapes by default but should add explicit sanitization.
    priority: Medium
    status: open
    affected_files:
      - convex/apartment.ts
      - convex/tasks.ts
      - convex/spaces.ts
    notes: |
      Add input sanitization:
      - Trim whitespace
      - Strip HTML tags (or use DOMPurify)
      - Limit input lengths
      - Validate special characters

  - id: no-rate-limiting
    title: No rate limiting on mutations - spam risk
    description: |
      Users can spam comments, task creation, item submissions without limit.
      Could overwhelm database or be used maliciously.
      Need rate limiting on backend.
    priority: Low
    status: open
    affected_files:
      - convex/apartment.ts
      - convex/tasks.ts
      - convex/spaces.ts
    notes: |
      Implement rate limiting:
      - Use Convex rate limiter (if available)
      - Or implement token bucket in database
      - Limit per user per time window
      - Show friendly error message when rate limited
